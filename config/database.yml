# PostgreSQL configuration
# Make sure PostgreSQL is installed and running:
#   macOS: brew install postgresql@16
#   Linux: sudo apt-get install postgresql postgresql-contrib
#   Windows: Download from https://www.postgresql.org/download/windows/
#
# Create databases:
#   createdb microblog_development
#   createdb microblog_test
#
# PgBouncer Support:
#   To use PgBouncer, set USE_PGBOUNCER=true and ensure PgBouncer is running on port 6432
#   See docs/PGBOUNCER_SETUP.md for setup instructions

default: &default
  adapter: postgresql
  encoding: unicode
  pool: <%= ENV.fetch("RAILS_MAX_THREADS") { 25 } %>
  timeout: 5000
  host: localhost
  port: <%= ENV.fetch("USE_PGBOUNCER", "false") == "true" ? 6432 : 5432 %>
  username: <%= ENV.fetch("DATABASE_USERNAME") { ENV["USER"] } %>
  password: <%= ENV.fetch("DATABASE_PASSWORD") { "" } %>
  # PgBouncer transaction pooling requires prepared_statements: false
  prepared_statements: <%= ENV.fetch("USE_PGBOUNCER", "false") == "true" ? false : true %>
  statement_limit: 1000

development:
  <<: *default
  database: microblog_development

# Warning: The database defined as "test" will be erased and
# re-generated from your development database when you run "rake".
# Do not set this db to the same as development or production.
test:
  <<: *default
  database: microblog_test

# Store production database in the storage/ directory, which by default
# is mounted as a persistent Docker volume in config/deploy.yml.
production:
  primary:
    <<: *default
    database: microblog_production
    username: <%= ENV.fetch("DATABASE_USERNAME") { "microblog" } %>
    password: <%= ENV.fetch("DATABASE_PASSWORD") { "" } %>
    host: <%= ENV.fetch("DATABASE_HOST") { "localhost" } %>
    port: <%= ENV.fetch("DATABASE_PORT") { ENV.fetch("USE_PGBOUNCER", "false") == "true" ? 6432 : 5432 } %>
  # Cache, queue, and cable use SQLite (lightweight, sufficient for these use cases)
  cache:
    adapter: sqlite3
    pool: <%= ENV.fetch("RAILS_MAX_THREADS") { 5 } %>
    timeout: 5000
    database: storage/production_cache.sqlite3
    migrations_paths: db/cache_migrate
  queue:
    adapter: sqlite3
    pool: <%= ENV.fetch("RAILS_MAX_THREADS") { 5 } %>
    timeout: 5000
    database: storage/production_queue.sqlite3
    migrations_paths: db/queue_migrate
  cable:
    adapter: sqlite3
    pool: <%= ENV.fetch("RAILS_MAX_THREADS") { 5 } %>
    timeout: 5000
    database: storage/production_cable.sqlite3
    migrations_paths: db/cable_migrate
