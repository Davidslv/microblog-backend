# PostgreSQL configuration
# Make sure PostgreSQL is installed and running:
#   macOS: brew install postgresql@16
#   Linux: sudo apt-get install postgresql postgresql-contrib
#   Windows: Download from https://www.postgresql.org/download/windows/
#
# Create databases:
#   createdb microblog_development
#   createdb microblog_test

default: &default
  adapter: postgresql
  encoding: unicode
  pool: <%= ENV.fetch("RAILS_MAX_THREADS") { 25 } %>
  timeout: 5000
  host: localhost
  port: 5432
  username: <%= ENV.fetch("DATABASE_USERNAME") { ENV["USER"] } %>
  password: <%= ENV.fetch("DATABASE_PASSWORD") { "" } %>
  prepared_statements: false
  statement_limit: 1000

development:
  primary:
    <<: *default
    database: microblog_development
    host: localhost
    port: 5432
    username: <%= ENV.fetch("DATABASE_USERNAME") { ENV["USER"] } %>
    password: <%= ENV.fetch("DATABASE_PASSWORD") { "" } %>

  # For development, use same database as primary (no actual replication needed)
  # In production, this would point to a replica server
  primary_replica:
    <<: *default
    database: microblog_development
    host: <%= ENV.fetch("REPLICA_HOST") { "localhost" } %>
    port: <%= ENV.fetch("REPLICA_PORT") { 5432 } %>
    username: <%= ENV.fetch("DATABASE_USERNAME") { ENV["USER"] } %>
    password: <%= ENV.fetch("DATABASE_PASSWORD") { "" } %>
    replica: true

  # Cache, queue, and cable use PostgreSQL (shared database for horizontal scaling)
  cache:
    adapter: postgresql
    database: microblog_cache
    host: <%= ENV.fetch("CACHE_DB_HOST") { ENV.fetch("DATABASE_HOST") { "localhost" } } %>
    port: <%= ENV.fetch("CACHE_DB_PORT") { ENV.fetch("DATABASE_PORT") { 5432 } } %>
    username: <%= ENV.fetch("CACHE_DB_USERNAME") { ENV.fetch("DATABASE_USERNAME") { ENV["USER"] } } %>
    password: <%= ENV.fetch("CACHE_DB_PASSWORD") { ENV.fetch("DATABASE_PASSWORD") { "" } } %>
    pool: <%= ENV.fetch("RAILS_MAX_THREADS") { 5 } %>
    migrations_paths: db/cache_migrate

  queue:
    adapter: postgresql
    database: microblog_queue
    host: <%= ENV.fetch("QUEUE_DB_HOST") { ENV.fetch("DATABASE_HOST") { "localhost" } } %>
    port: <%= ENV.fetch("QUEUE_DB_PORT") { ENV.fetch("DATABASE_PORT") { 5432 } } %>
    username: <%= ENV.fetch("QUEUE_DB_USERNAME") { ENV.fetch("DATABASE_USERNAME") { ENV["USER"] } } %>
    password: <%= ENV.fetch("QUEUE_DB_PASSWORD") { ENV.fetch("DATABASE_PASSWORD") { "" } } %>
    pool: <%= ENV.fetch("RAILS_MAX_THREADS") { 5 } %>
    migrations_paths: db/queue_migrate

  cable:
    adapter: postgresql
    database: microblog_cable
    host: <%= ENV.fetch("CABLE_DB_HOST") { ENV.fetch("DATABASE_HOST") { "localhost" } } %>
    port: <%= ENV.fetch("CABLE_DB_PORT") { ENV.fetch("DATABASE_PORT") { 5432 } } %>
    username: <%= ENV.fetch("CABLE_DB_USERNAME") { ENV.fetch("DATABASE_USERNAME") { ENV["USER"] } } %>
    password: <%= ENV.fetch("CABLE_DB_PASSWORD") { ENV.fetch("DATABASE_PASSWORD") { "" } } %>
    pool: <%= ENV.fetch("RAILS_MAX_THREADS") { 5 } %>
    migrations_paths: db/cable_migrate

# Warning: The database defined as "test" will be erased and
# re-generated from your development database when you run "rake".
# Do not set this db to the same as development or production.
test:
  primary:
    <<: *default
    database: microblog_test
    host: localhost
    port: 5432
    username: <%= ENV.fetch("DATABASE_USERNAME") { ENV["USER"] } %>
    password: <%= ENV.fetch("DATABASE_PASSWORD") { "" } %>

  # For tests, use same database (replica support is optional)
  primary_replica:
    <<: *default
    database: microblog_test
    host: <%= ENV.fetch("REPLICA_HOST") { "localhost" } %>
    port: <%= ENV.fetch("REPLICA_PORT") { 5432 } %>
    username: <%= ENV.fetch("DATABASE_USERNAME") { ENV["USER"] } %>
    password: <%= ENV.fetch("DATABASE_PASSWORD") { "" } %>
    replica: true

  # Cache, queue, and cable use PostgreSQL (shared database for horizontal scaling)
  cache:
    adapter: postgresql
    database: microblog_cache_test
    host: <%= ENV.fetch("CACHE_DB_HOST") { ENV.fetch("DATABASE_HOST") { "localhost" } } %>
    port: <%= ENV.fetch("CACHE_DB_PORT") { ENV.fetch("DATABASE_PORT") { 5432 } } %>
    username: <%= ENV.fetch("CACHE_DB_USERNAME") { ENV.fetch("DATABASE_USERNAME") { ENV["USER"] } } %>
    password: <%= ENV.fetch("CACHE_DB_PASSWORD") { ENV.fetch("DATABASE_PASSWORD") { "" } } %>
    pool: <%= ENV.fetch("RAILS_MAX_THREADS") { 5 } %>
    migrations_paths: db/cache_migrate

  queue:
    adapter: postgresql
    database: microblog_queue_test
    host: <%= ENV.fetch("QUEUE_DB_HOST") { ENV.fetch("DATABASE_HOST") { "localhost" } } %>
    port: <%= ENV.fetch("QUEUE_DB_PORT") { ENV.fetch("DATABASE_PORT") { 5432 } } %>
    username: <%= ENV.fetch("QUEUE_DB_USERNAME") { ENV.fetch("DATABASE_USERNAME") { ENV["USER"] } } %>
    password: <%= ENV.fetch("QUEUE_DB_PASSWORD") { ENV.fetch("DATABASE_PASSWORD") { "" } } %>
    pool: <%= ENV.fetch("RAILS_MAX_THREADS") { 5 } %>
    migrations_paths: db/queue_migrate

  cable:
    adapter: postgresql
    database: microblog_cable_test
    host: <%= ENV.fetch("CABLE_DB_HOST") { ENV.fetch("DATABASE_HOST") { "localhost" } } %>
    port: <%= ENV.fetch("CABLE_DB_PORT") { ENV.fetch("DATABASE_PORT") { 5432 } } %>
    username: <%= ENV.fetch("CABLE_DB_USERNAME") { ENV.fetch("DATABASE_USERNAME") { ENV["USER"] } } %>
    password: <%= ENV.fetch("CABLE_DB_PASSWORD") { ENV.fetch("DATABASE_PASSWORD") { "" } } %>
    pool: <%= ENV.fetch("RAILS_MAX_THREADS") { 5 } %>
    migrations_paths: db/cable_migrate

# Store production database in the storage/ directory, which by default
# is mounted as a persistent Docker volume in config/deploy.yml.
production:
  primary:
    <<: *default
    database: microblog_production
    username: <%= ENV.fetch("DATABASE_USERNAME") { "microblog" } %>
    password: <%= ENV.fetch("DATABASE_PASSWORD") { "" } %>
    host: <%= ENV.fetch("DATABASE_HOST") { "localhost" } %>
    port: <%= ENV.fetch("DATABASE_PORT") { 5432 } %>

  # Read replica configuration
  # In production, this should point to a replica server
  primary_replica:
    <<: *default
    database: microblog_production
    username: <%= ENV.fetch("REPLICA_USERNAME") { ENV.fetch("DATABASE_USERNAME") { "microblog" } } %>
    password: <%= ENV.fetch("REPLICA_PASSWORD") { ENV.fetch("DATABASE_PASSWORD") { "" } } %>
    host: <%= ENV.fetch("REPLICA_HOST") { ENV.fetch("DATABASE_HOST") { "localhost" } } %>
    port: <%= ENV.fetch("REPLICA_PORT") { ENV.fetch("DATABASE_PORT") { 5432 } } %>
    replica: true

  # Cache, queue, and cable use PostgreSQL (required for horizontal scaling)
  # SQLite files cannot be shared across multiple servers
  cache:
    adapter: postgresql
    database: microblog_cache
    host: <%= ENV.fetch("CACHE_DB_HOST") { ENV.fetch("DATABASE_HOST") { "localhost" } } %>
    port: <%= ENV.fetch("CACHE_DB_PORT") { ENV.fetch("DATABASE_PORT") { 5432 } } %>
    username: <%= ENV.fetch("CACHE_DB_USERNAME") { ENV.fetch("DATABASE_USERNAME") { "microblog" } } %>
    password: <%= ENV.fetch("CACHE_DB_PASSWORD") { ENV.fetch("DATABASE_PASSWORD") { "" } } %>
    pool: <%= ENV.fetch("RAILS_MAX_THREADS") { 5 } %>
    migrations_paths: db/cache_migrate

  queue:
    adapter: postgresql
    database: microblog_queue
    host: <%= ENV.fetch("QUEUE_DB_HOST") { ENV.fetch("DATABASE_HOST") { "localhost" } } %>
    port: <%= ENV.fetch("QUEUE_DB_PORT") { ENV.fetch("DATABASE_PORT") { 5432 } } %>
    username: <%= ENV.fetch("QUEUE_DB_USERNAME") { ENV.fetch("DATABASE_USERNAME") { "microblog" } } %>
    password: <%= ENV.fetch("QUEUE_DB_PASSWORD") { ENV.fetch("DATABASE_PASSWORD") { "" } } %>
    pool: <%= ENV.fetch("RAILS_MAX_THREADS") { 5 } %>
    migrations_paths: db/queue_migrate

  cable:
    adapter: postgresql
    database: microblog_cable
    host: <%= ENV.fetch("CABLE_DB_HOST") { ENV.fetch("DATABASE_HOST") { "localhost" } } %>
    port: <%= ENV.fetch("CABLE_DB_PORT") { ENV.fetch("DATABASE_PORT") { 5432 } } %>
    username: <%= ENV.fetch("CABLE_DB_USERNAME") { ENV.fetch("DATABASE_USERNAME") { "microblog" } } %>
    password: <%= ENV.fetch("CABLE_DB_PASSWORD") { ENV.fetch("DATABASE_PASSWORD") { "" } } %>
    pool: <%= ENV.fetch("RAILS_MAX_THREADS") { 5 } %>
    migrations_paths: db/cable_migrate
